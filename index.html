<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BRCGS Validator | Full Width</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-body: #F3F4F6;
            --bg-card: #FFFFFF;
            --primary-green: #43A047;
            --primary-hover: #2E7D32;
            --score-blue: #3B82F6;
            --score-track: #E5E7EB;
            --text-main: #1F2937;
            --text-muted: #6B7280;
            --crit-bg: #FEF2F2;
            --crit-border: #EF4444;
            --warn-bg: #FFFBEB;
            --warn-border: #F59E0B;
            --radius: 12px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        * { box-sizing: border-box; outline: none; }

        body {
            margin: 0;
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            /* Changement 1: On autorise le scroll de page */
            overflow-y: auto; 
        }

        /* --- HEADER --- */
        header {
            background: var(--bg-card);
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 2rem;
            border-bottom: 1px solid #E5E7EB;
            position: sticky; /* Le header reste en haut */
            top: 0;
            z-index: 50;
        }

        .brand { font-weight: 700; font-size: 1.3rem; color: #111827; }
        .toolbar { display: flex; gap: 10px; }

        .btn-small {
            background: white;
            border: 1px solid #D1D5DB;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .btn-small:hover { border-color: var(--text-main); color: var(--text-main); background: #F9FAFB; }

        /* --- MAIN LAYOUT --- */
        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 30px 20px;
            gap: 30px;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }

        /* EDITOR SECTION */
        .editor-card {
            background: var(--bg-card);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 30px;
            display: flex;
            flex-direction: column;
            /* Changement 2: Hauteur auto pour s'adapter au contenu */
            height: auto; 
        }

        .card-header {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text-main);
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
        }

        .input-wrapper {
            position: relative;
            border: 2px solid #E5E7EB;
            border-radius: 8px;
            min-height: 200px; /* Hauteur minimale confortable */
            background: white;
            transition: border-color 0.2s;
        }
        
        .input-wrapper:focus-within { border-color: var(--primary-green); }

        textarea, #viewMode {
            width: 100%;
            min-height: 200px; /* S'assure que la zone est assez grande */
            border: none;
            padding: 20px;
            font-family: 'Roboto Mono', monospace;
            font-size: 1rem;
            line-height: 1.6;
            resize: vertical; /* Permet √† l'utilisateur d'agrandir */
            background: transparent;
            color: var(--text-main);
            display: block;
        }

        /* HIGHLIGHTING */
        .mark { cursor: pointer; border-radius: 3px; padding: 2px 0; border-bottom: 2px solid; transition: background 0.2s; }
        .mark.crit { background-color: var(--crit-bg); border-color: var(--crit-border); color: #991B1B; }
        .mark.warn { background-color: var(--warn-bg); border-color: var(--warn-border); color: #92400E; }
        .mark:hover { filter: brightness(0.95); }

        .btn-analyze {
            background-color: var(--primary-green);
            color: white;
            font-weight: 600;
            font-size: 1.1rem;
            border: none;
            border-radius: 6px;
            padding: 14px;
            width: 100%;
            margin-top: 20px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .btn-analyze:hover { background-color: var(--primary-hover); }

        /* RESULTS SECTION - GRID LAYOUT */
        .results-wrapper {
            display: flex;
            gap: 30px;
            align-items: flex-start; /* Important: aligne en haut */
        }

        /* SCORE CARD - STICKY */
        .score-card {
            background: var(--bg-card);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            width: 320px;
            padding: 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            
            /* Changement 3: Sticky Position */
            position: sticky;
            top: 100px; /* Reste visible quand on scroll */
        }

        .score-circle {
            position: relative;
            width: 160px;
            height: 160px;
        }
        
        .score-circle svg { transform: rotate(-90deg); width: 100%; height: 100%; }
        .circle-bg { stroke: var(--score-track); }
        .circle-bar { stroke: var(--score-blue); transition: stroke-dashoffset 1s ease-out; }
        
        .score-number {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3rem;
            font-weight: 700;
            color: var(--text-main);
        }
        
        .score-label {
            margin-top: 20px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            text-align: center;
        }

        /* ISSUES PANEL - FLUID WIDTH */
        .issues-panel {
            flex: 1; /* Prend tout l'espace restant */
            display: flex;
            flex-direction: column;
            gap: 15px;
            /* Changement 4: Plus de scroll interne */
        }

        .panel-header {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--text-main);
        }

        .issue-item {
            background: var(--bg-card);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 20px;
            border-left: 5px solid #ccc;
            animation: fadeIn 0.4s ease;
        }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .issue-item.crit { border-left-color: var(--crit-border); background: #FEF2F2; }
        .issue-item.warn { border-left-color: var(--warn-border); background: #FFFBEB; }
        .issue-item.good { border-left-color: #10B981; background: #ECFDF5; }

        .issue-title { font-weight: 700; font-size: 1.05rem; display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
        .issue-title.crit { color: #991B1B; }
        .issue-title.warn { color: #92400E; }

        .issue-desc { font-size: 0.95rem; color: #374151; line-height: 1.6; }
        .suggestion { 
            margin-top: 12px; 
            padding-top: 12px; 
            border-top: 1px solid rgba(0,0,0,0.05);
            font-size: 0.9rem; 
            font-style: italic; 
            color: #555; 
            display: flex; 
            gap: 8px; 
        }

        /* RESPONSIVE */
        @media (max-width: 900px) {
            .results-wrapper {
                flex-direction: column; /* Stack vertically on tablet */
            }
            .score-card {
                width: 100%; /* Full width score */
                position: static; /* No sticky on mobile */
                flex-direction: row; /* Horizontal layout for score card */
                justify-content: space-between;
                padding: 20px;
                gap: 20px;
            }
            .score-circle { width: 80px; height: 80px; }
            .score-number { font-size: 1.5rem; }
        }
        
        @media (max-width: 600px) {
            .score-card { flex-direction: column; text-align: center; }
            header { padding: 0 1rem; }
            .brand { font-size: 1rem; }
            .btn-small span { display: none; } /* Hide text on small buttons */
        }

        .hidden { display: none !important; }
        
    </style>
</head>
<body>

    <header>
        <div class="brand">BRCGS Validator</div>
        <div class="toolbar">
            <button class="btn-small" onclick="loadDemo()"><span>‚ö°</span> Load Demo</button>
            <button class="btn-small" onclick="resetApp()"><span>üîÑ</span> Reset</button>
            <button class="btn-small" onclick="copyText()"><span>üìã</span> Copy Text</button>
        </div>
    </header>

    <main>
        <!-- EDITOR SECTION -->
        <section class="editor-card">
            <div class="card-header">
                <span>Certification Scope</span>
                <span style="font-weight:400; font-size:0.9rem; color:var(--text-muted);" id="charCount">0 chars</span>
            </div>
            
            <div class="input-wrapper">
                <textarea id="scopeInput" placeholder="Paste your BRCGS Scope text here to begin analysis..."></textarea>
                <div id="viewMode" class="hidden"></div>
            </div>

            <button class="btn-analyze" id="analyzeBtn" onclick="analyze()">Analyze Scope</button>
            <button class="btn-small" id="editBtn" onclick="toggleEdit()" style="margin-top:15px; width:100%; display:none; justify-content:center; background:#F3F4F6;">‚úèÔ∏è Edit Text</button>
        </section>

        <!-- RESULTS SECTION -->
        <div class="results-wrapper">
            
            <!-- SCORE CARD (Sticky Left) -->
            <div class="score-card">
                <div style="font-weight:700; margin-bottom:20px; color:var(--text-main);">Conformity Score</div>
                <div class="score-circle">
                    <svg viewBox="0 0 100 100">
                        <circle class="circle-bg" cx="50" cy="50" r="45" fill="none" stroke-width="8"></circle>
                        <circle class="circle-bar" id="scoreRing" cx="50" cy="50" r="45" fill="none" stroke-width="8" stroke-dasharray="283" stroke-dashoffset="283"></circle>
                    </svg>
                    <div class="score-number" id="scoreVal">--</div>
                </div>
                <div class="score-label" id="scoreLabel">Waiting for input</div>
            </div>

            <!-- ISSUES LIST (Expands Right) -->
            <div class="issues-panel" id="issuesList">
                <!-- Placeholder -->
                <div style="text-align:center; padding: 40px; color:#9CA3AF; background:white; border-radius:12px; border: 2px dashed #E5E7EB;">
                    <div style="font-size:2.5rem; margin-bottom:15px; opacity:0.5;">üõ°Ô∏è</div>
                    <div style="font-size:1.1rem; font-weight:600;">Ready to Analyze</div>
                    <p>Enter your scope text above and click the green button.<br>F931 Compliance checks will appear here.</p>
                </div>
            </div>

        </div>
    </main>

    <script>
        // --- LOGIC ENGINE ---
        const RULES = [
            {
                id: 'out_of_scope', severity: 'crit',
                regex: /\b(marketing|sales|distribution|transport|delivery|growing|procurement|product design|handling|storage)\b/gi,
                title: "Out-of-Scope Activity",
                desc: "Terms describing logistics/business functions (Sales, Distribution, Marketing) are forbidden in the audit scope.",
                tip: "Focus only on manufacturing/packing steps. Remove business functions."
            },
            {
                id: 'claims', severity: 'crit',
                regex: /\b(organic|halal|kosher|free from|gluten.?free|vegan|vegetarian|non.?gmo|fortified|allergen.?free|without meat)\b/gi,
                title: "Forbidden Product Claim",
                desc: "Product claims (provenance, nutritional, religious) must not be in the scope text.",
                tip: "Describe composition (e.g. 'Rice flour bread'), not certification status (e.g. 'Gluten-free')."
            },
            {
                id: 'brand', severity: 'crit',
                regex: /\b(Coca.?Cola|Nestle|Danone|Tesco|Walmart|Mars|Cadbury|Pepsi)\b/gi,
                title: "Brand Name Detected",
                desc: "Brand names are strictly forbidden in the scope.",
                tip: "Use generic product categories (e.g. 'Soft drinks' instead of 'Pepsi')."
            },
            {
                id: 'traded_fmt', severity: 'crit',
                regex: /\b(trading|factoring)(?!\s+of)\b/gi,
                title: "Traded Goods Format",
                desc: "Incorrect format for traded goods.",
                tip: "Use exact phrase: 'Trading of [product types]'."
            },
            {
                id: 'outsourced_fmt', severity: 'crit',
                regex: /\b(outsourced)\b/gi,
                custom: (txt, m) => {
                    const snip = txt.substr(Math.max(0, m.index-15), 50).toLowerCase();
                    return !snip.includes('including') || !txt.substr(m.index, 50).includes('on');
                },
                title: "Outsourced Process Format",
                desc: "The phrasing for outsourced processes is incorrect.",
                tip: "Required format: 'including outsourced [process] on [products]'."
            },
            {
                id: 'headoffice_fmt', severity: 'crit',
                regex: /\b(head office)\b/gi,
                custom: (txt, m) => {
                    const snip = txt.substr(Math.max(0, m.index-20), 60).toLowerCase();
                    return !snip.includes('incorporating') || !snip.includes('audit at');
                },
                title: "Head Office Format",
                desc: "The phrasing for Head Office audit is incorrect.",
                tip: "Required format: 'Incorporating head office audit at [address]'."
            },
            {
                id: 'vague', severity: 'warn',
                regex: /\b(production|manufacture|processing|preparation|making)\b/gi,
                title: "Vague Process Term",
                desc: "Generic terms are discouraged by F931.",
                tip: "Use specific verbs: Baking, Mixing, Pasteurisation, Packing, Assembling."
            }
        ];

        function analyze() {
            const input = document.getElementById('scopeInput');
            const view = document.getElementById('viewMode');
            const list = document.getElementById('issuesList');
            const raw = input.value.trim();

            if (!raw) return;

            // Switch to View Mode
            input.classList.add('hidden');
            view.classList.remove('hidden');
            document.getElementById('analyzeBtn').classList.add('hidden');
            document.getElementById('editBtn').style.display = 'flex';

            // Clear Results
            view.innerHTML = '';
            list.innerHTML = '<div class="panel-header">Analysis Results</div>';

            let score = 100;
            let findings = [];
            let globalNotes = [];

            // 1. Regex Pass
            RULES.forEach(rule => {
                let match;
                rule.regex.lastIndex = 0;
                while ((match = rule.regex.exec(raw)) !== null) {
                    if (rule.custom && !rule.custom(raw, match)) continue;
                    findings.push({ start: match.index, end: match.index + match[0].length, text: match[0], rule: rule });
                }
            });

            // 2. Global Checks
            if (raw.split(' ').length > 60) {
                score -= 5;
                globalNotes.push({ title: "Scope Too Long", desc: "Your scope exceeds 60 words. F931 recommends keeping it succinct.", type: "warn", tip: "Group similar products together." });
            }
            const verbs = ["baking","cooking","mixing","packing","pasteurisation","cutting","slicing","bottling","fermentation"];
            if (!verbs.some(v => raw.toLowerCase().includes(v))) {
                score -= 10;
                globalNotes.push({ title: "Missing Process Verb", desc: "No specific process verb found (e.g. Baking, Bottling).", type: "warn", tip: "Ensure the main technology is described." });
            }

            // 3. Render Highlights & Issues
            findings.sort((a,b) => a.start - b.start);
            let last = 0;
            findings.forEach(f => {
                // Text before
                view.appendChild(document.createTextNode(raw.substring(last, f.start)));
                // Highlight
                const span = document.createElement('span');
                span.className = `mark ${f.rule.severity}`;
                span.innerText = raw.substring(f.start, f.end);
                span.onclick = () => scrollToIssue(f.rule.id);
                view.appendChild(span);
                
                // Add card to list (prevent duplicates visually if same error appears multiple times? typically list all)
                // For cleaner UI, we list all.
                addIssueCard(f.rule, f.text);
                
                score -= (f.rule.severity === 'crit' ? 15 : 5);
                last = f.end;
            });
            view.appendChild(document.createTextNode(raw.substring(last)));

            // 4. Render Global Notes
            globalNotes.forEach(n => addGlobalCard(n));

            // 5. Update Score
            score = Math.max(0, score);
            updateScoreUI(score);

            if(findings.length === 0 && globalNotes.length === 0) {
                list.innerHTML += `
                <div class="issue-item good">
                    <div class="issue-title" style="color:#047857">‚úÖ No Issues Found</div>
                    <div class="issue-desc">Your scope appears to be compliant with F931 guidelines.</div>
                </div>`;
            }
        }

        function addIssueCard(rule, text) {
            const list = document.getElementById('issuesList');
            const div = document.createElement('div');
            // Unique ID for scrolling (add random suffix if multiple same errors)
            const uid = `issue-${rule.id}-${Math.floor(Math.random()*1000)}`;
            div.className = `issue-item ${rule.severity}`;
            div.id = uid;
            
            // Map highlighting back to this card
            // Note: simple mapping for this demo
            
            div.innerHTML = `
                <div class="issue-title ${rule.severity}">
                    ${rule.severity === 'crit' ? '‚ùå Critical Issue' : '‚ö†Ô∏è Warning'} : ${rule.title}
                </div>
                <div class="issue-desc">
                    "${text}" - ${rule.desc}
                </div>
                <div class="suggestion">üí° Tip: ${rule.tip}</div>
            `;
            list.appendChild(div);
            
            // Re-bind the click event on the last created span to this specific card
            // (A simplified approach for the demo)
        }

        function addGlobalCard(note) {
            const list = document.getElementById('issuesList');
            const div = document.createElement('div');
            div.className = `issue-item ${note.type}`;
            div.innerHTML = `
                <div class="issue-title ${note.type}">‚ö†Ô∏è ${note.title}</div>
                <div class="issue-desc">${note.desc}</div>
                ${note.tip ? `<div class="suggestion">üí° Tip: ${note.tip}</div>` : ''}
            `;
            list.prepend(div);
        }

        function updateScoreUI(score) {
            const ring = document.getElementById('scoreRing');
            const val = document.getElementById('scoreVal');
            const label = document.getElementById('scoreLabel');
            
            const offset = 283 - (score / 100 * 283);
            ring.style.strokeDashoffset = offset;
            
            let color = '#3B82F6'; 
            let text = "Needs Tweaks";
            
            if (score >= 90) { color = '#10B981'; text = "Excellent"; }
            else if (score >= 70) { color = '#3B82F6'; text = "Good"; }
            else if (score < 50) { color = '#EF4444'; text = "Critical Issues"; }
            
            ring.style.stroke = color;
            val.innerText = score + '%';
            label.innerText = text;
        }

        function toggleEdit() {
            document.getElementById('scopeInput').classList.remove('hidden');
            document.getElementById('viewMode').classList.add('hidden');
            document.getElementById('analyzeBtn').classList.remove('hidden');
            document.getElementById('editBtn').style.display = 'none';
        }

        function scrollToIssue(id) {
            // Find the first card with that rule ID prefix
            const cards = document.querySelectorAll(`[id^="issue-${id}"]`);
            if(cards.length > 0) {
                cards[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
                cards[0].style.transform = "scale(1.02)";
                setTimeout(() => cards[0].style.transform = "scale(1)", 200);
            }
        }

        function resetApp() {
            document.getElementById('scopeInput').value = '';
            toggleEdit();
            document.getElementById('issuesList').innerHTML = `
                <div style="text-align:center; padding: 40px; color:#9CA3AF; background:white; border-radius:12px; border: 2px dashed #E5E7EB;">
                    <div style="font-size:2.5rem; margin-bottom:15px; opacity:0.5;">üõ°Ô∏è</div>
                    <div style="font-size:1.1rem; font-weight:600;">Ready to Analyze</div>
                    <p>Enter your scope text above and click the green button.</p>
                </div>`;
            updateScoreUI(0);
            document.getElementById('scoreLabel').innerText = "Waiting for input";
            document.getElementById('charCount').innerText = "0 chars";
            document.getElementById('scoreRing').style.strokeDashoffset = 283;
        }

        function loadDemo() {
            document.getElementById('scopeInput').value = "Mixing, cooking, pasteurization, packing, freezing of meat paste, meat extract and animal fat in buckets, plastic pouches or bulk containers. Mixing, cooking, drying, packing of dried culinary bases (soup, broth, meat powder) in non-woven plastic filter and plastic bags. Preparation by mixing of dehydrated ingredients, grinding, packing of dehydrated miso soups into laminated bags or plastic pots. Including outsourced packing of dehydrated miso soups and dry broths into laminated bags or plastic pots.";
            document.getElementById('charCount').innerText = document.getElementById('scopeInput').value.length + " chars";
            analyze();
        }

        function copyText() {
            const txt = document.getElementById('scopeInput').value;
            if(txt) {
                navigator.clipboard.writeText(txt);
                alert("Copied to clipboard");
            }
        }

        document.getElementById('scopeInput').addEventListener('input', function() {
            document.getElementById('charCount').innerText = this.value.length + " chars";
        });

    </script>
</body>
</html>
